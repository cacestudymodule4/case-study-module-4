<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vngram</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" th:href="@{/property/home/home.css}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" th:href="@{/property/like/like.css}">
</head>
<body>
<div class="container-fluid main-container">
    <div class="sidebar-left" style="width: 15%;margin-top: -3%;">
        <a href="/home"><h3 class="mb-3">ùì•ùì∑ùì∞ùìªùì™ùì∂</h3></a>
        <a class="link-icon ms-3" href="/home"><i class="fa-brands fa-instagram home icons2"></i><span
                style="font-weight: bold">Trang ch·ªß</span></a>
        <a class="link-icon" href="/friendship/search"> <i class="fas fa-search icons2" title="Search"></i><span>T√¨m ki·∫øm</span></a>
        <a class="link-icon notification" href="/notification"> <i class="far fa-heart icons2"
                                                                   title="Likes"></i><span>Th√¥ng b√°o</span>
            <th:block th:if="${newNotify > 0}">
                <span class="notification-badge" th:text="${newNotify}">6</span>
            </th:block>
        </a>
        <a class="link-icon notification" href="/message">
            <i class="fa-regular fa-message icons2"></i>
            <span>Tin nh·∫Øn</span>
            <th:block th:if="${newMessages > 0}">
                <span class="notification-badge" th:text="${newMessages}">5</span>
            </th:block>
        </a>
        <a class="link-icon" th:href="@{/user/__${user.id}__}"> <i class="far fa-user icons2"
                                                                   title="Profile"></i><span>Trang c√° nh√¢n</span></a>
        <a class="link-icon" style="margin-top: 100%" href="/logout"><i
                class="fa-solid fa-arrow-right-from-bracket icons2"
                title="Logout"></i><span>ƒêƒÉng xu·∫•t</span></a>
    </div>
    <div class="content-area" style="margin-left: 34%;margin-top: -2%">
        <div class="feed-post mt-1 mb-5" th:each="postDTO,postIdx :${postDTOS}">
            <div class="post-header">
                <a th:href="@{/user/__${postDTO.user.id}__}">
                    <div style="width: 459px">
                        <img th:src="@{__${postDTO.user.profilePic}__}"
                             alt="Profile" class="profile-img">
                        <strong style="color: black" th:text="${postDTO.user.fullName}">Nguy·ªÖn Th·ªã T·∫°ch</strong>
                        <span class="fw-bold time" th:text="${postDTO.post.createdAt}">12 gi·ªù</span>
                    </div>
                </a>
                <a href="#" data-bs-toggle="modal" th:data-bs-target="'#modal' + ${postDTO.post.id}">
                    <div class="dots-container">
                        <div class="dot"></div>
                    </div>
                </a>
            </div>
            <div th:id="'carouselExample_' + ${postIdx.index}" class="carousel slide">
                <div class="carousel-indicators">
                    <th:block th:each="media,s :${postDTO.mediaList}">
                        <button type="button" th:data-bs-target="'#carouselExample_' + ${s.index}"
                                th:data-bs-slide-to="${s.index}"
                                th:class="${s.index == 0 ? 'active' : ''}"
                                aria-current="true" th:aria-label="'Slide' + ${s.index}"></button>
                    </th:block>
                </div>
                <div class="carousel-inner">
                    <a th:href="@{/post/view/__${postDTO.post.id}__}">
                        <th:block th:each="media,s :${postDTO.mediaList}">
                            <div th:class="'carousel-item' + ${s.index == 0 ? ' active':''}">
                                <img th:src="@{__${media.mediaUrl}__}"
                                     th:alt="'media '+${s.count}">
                            </div>
                        </th:block>
                    </a>
                    <button class="carousel-control-prev" type="button"
                            th:attr="data-bs-target='#carouselExample_' + ${postIdx.index}"
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button"
                            th:attr="data-bs-target='#carouselExample_' + ${postIdx.index}"
                            data-bs-slide="next" style="right: -9%;">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
            <div class="post-footer" style="margin-left: -16px">
                <div class="post-actions" style="color: black">
                    <a th:id="'is-like-' + ${postDTO.post.id}"
                       th:style="'display: ' + (${postDTO.like.contains(user) ? 'inline-block' : 'none'})">
                        <i class="fa-solid fa-heart" style="color:red"></i>
                    </a>
                    <a th:id="'un-like-' + ${postDTO.post.id}"
                       th:style="'display: ' + (${postDTO.like.contains(user) ? 'none' : 'inline-block'})">
                        <i class="bi bi-heart"></i>
                    </a>
                    <a href=""> <i class="bi bi-chat"></i></a>
                    <a href=""> <i class="bi bi-send"></i></a>
                </div>
                <div>
                    <p class="likes" th:id="'like-count-' + ${postDTO.post.id}"
                       th:text="${postDTO.like.size()} + ' likes'">0
                        likes</p>
                    <span class="desc" th:text="${postDTO.post.content}">Chuy·ªán l√† h√¥m qua em m·ªõi chia tay ng∆∞·ªùi y√™u Em bu·ªìn qu√° em ƒëi h·ªçc code.C√≥ c√°i code kh√≥ qu√° em h·ªçc kh√¥ng
                    ƒë∆∞·ª£c em bu·ªìn n·ªØa </span>
                </div>
                <div class="mt-3"><a
                        th:href="@{/post/view/__${postDTO.post.id}__}"
                        style="color:#737373 ;"> xem t·∫•t c·∫£ <span th:text="${postDTO.commentList.size()}">300</span>
                    b√¨nh lu·∫≠n</a></div>
            </div>
            <div class="modal fade" th:id="'modal' + ${postDTO.post.id}" tabindex="-1"
                 aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                            <th:block th:if="${user.id != postDTO.user.id}">
                                <a href="#">
                                    <div class="modal-a a1 text-center">
                                        B·ªè theo d√µi
                                    </div>
                                </a>
                                <a href="#">
                                    <div class="modal-a text-center">
                                        ·∫®n b√†i vi·∫øt
                                    </div>
                                </a>
                                <a href="#">
                                    <div class="modal-a text-center">
                                        B√°o c√°o
                                    </div>
                                </a>
                            </th:block>
                            <th:block th:if="${user.id == postDTO.user.id}">
                                <a href="#">
                                    <div class="modal-a a1 text-center">
                                        Ch·ªânh s·ª≠a
                                    </div>
                                </a>
                                <a th:href="@{/post/delete/__${postDTO.post.id}__}">
                                    <div class="modal-a text-center">
                                        X√≥a
                                    </div>
                                </a>
                            </th:block>
                            <a href="#" data-bs-dismiss="modal">
                                <div class="modal-a a1 text-center">
                                    Hu·ª∑
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar-right" style="width: 15%;margin-top:-2%">
        <a th:href="@{/user/__${user.id}__}">
            <div class="user-profile">
                <img th:src="@{__${user.profilePic}__}" alt="avatar">
                <div>
                    <strong th:text="${user.fullName}">L·ªç Lem 006</strong><br>
                </div>
            </div>
        </a>
        <div class="suggestions">
            <p class="fw-bold" style="color:#737373 ;">G·ª£i √Ω cho b·∫°n</p>
            <th:block th:each="usert :${top4User}">
                <a th:href="@{/user/__${usert.id}__}">
                    <div class="suggestion-item">
                        <img th:src="@{__${usert.profilePic}__}" alt="">
                        <div>
                            <strong th:text="${usert.fullName}">Linh L√≤ng</strong><br>
                        </div>
                    </div>
                </a>
            </th:block>
            <div>
                <a href="/friendship/search"><p class="fw-bold" style="color:#737373 ;margin-top: 30px">Xem t·∫•t c·∫£</p>
                </a>
            </div>
        </div>
    </div>
</div>
<div id="modal" class="l-modal">
    <div class="l-modal-content">
        <span class="close">&times;</span>
        <h2>Like</h2>
        <div style="width: 500px; height: 500px">
            <ul id="listLike">
            </ul>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script>
    const timeElements = document.querySelectorAll('.time');
    // L·∫∑p qua t·ª´ng th·∫ª span v√† ƒë·ªãnh d·∫°ng ng√†y th√°ng
    timeElements.forEach(element => {
        const createdAt = element.innerText; // L·∫•y gi√° tr·ªã ng√†y th√°ng
        const formattedTime = moment(createdAt).fromNow(); // ƒê·ªãnh d·∫°ng kho·∫£ng th·ªùi gian
        element.innerText = formattedTime; // G√°n l·∫°i gi√° tr·ªã ƒë√£ ƒë·ªãnh d·∫°ng
    });
    var modal = document.getElementById("modal");
    var span = document.getElementsByClassName("close")[0];
    $(document).ready(function () {
        $('[id^="like-count"]').click(function () {
            const postId = this.id.split('-')[2];
            getListLike(postId);
        });
        $('[id^="is-like"]').click(function () {
            const postId = this.id.split('-')[2];
            like(postId);
        });
        $('[id^="un-like"]').click(function () {
            const postId = this.id.split('-')[2];
            like(postId);
        });
    });

    function like(postId) {
        $.ajax({
            url: "http://localhost:8080/api/like/likePost",
            type: "post",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
                id: postId
            }),
            success: function (data, status, xhr) {
                if (xhr.status === 200) {
                    updateLikeIcon(postId, "like")
                } else if (xhr.status === 204) {
                    updateLikeIcon(postId, "un-like")
                }
            }
        });
    }

    function updateLikeIcon(postId, status) {
        if (status === "like") {
            $('#is-like-' + postId).show();
            $('#un-like-' + postId).hide();
        } else if (status === 'un-like') {
            $('#is-like-' + postId).hide();
            $('#un-like-' + postId).show();
        }
        updateCountLike(postId)
    }

    function updateCountLike(postId) {
        $.ajax({
            url: "http://localhost:8080/api/like/list",
            type: "post",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
                id: postId
            }),
            success: function (data) {
                $('#like-count-' + postId).html(data.length + ' likes')
            }
        });
    }

    function getListLike(postId) {
        $.ajax({
            url: `http://localhost:8080/api/like/list`,
            method: 'POST',
            dataType: "json",
            contentType: 'application/json',
            data: JSON.stringify({
                id: postId
            }),
            success: function (data) {
                showListLike(data);
            },
            error: function (xhr, status, error) {
                console.log('L·ªói khi ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n:', error);
            }
        });
    }

    function showListLike(data) {
        $('#listLike').empty();
        data.forEach(item => {
            const likeHtml = `
                <a href="/user/${item.user.id}">
                    <li>
                        <div style="width: 459px">
                            <img src="${item.user.profilePic}"
                                 alt="Profile" class="profile-img">
                            <p style="color: black; display: inline-block">${item.user.fullName}</p>
                        </div>
                    </li>
                </a>`;
            $('#listLike').append(likeHtml);
        });
        modal.style.display = "block";
    }

    span.onclick = function () {
        modal.style.display = "none";
    }
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>