<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Messaging UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" th:href="@{/property/message/message.css}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container-fluid chat-container">
    <div class="sidebar">
        <div class="icon-bar">
            <i class="fa-brands fa-instagram home icons"></i>
            <i class="fas fa-search icons" title="Search"></i>
            <i class="far fa-compass icons" title="Explore"></i>
            <i class="far fa-heart icons" title="Likes"></i>
            <i class="fa-regular fa-comments icons"></i>
            <i class="far fa-user icons" title="Profile"></i>
            <i class="fa-solid fa-arrow-right-from-bracket icons" title="Logout" style="margin-top: 50%"></i>
        </div>
    </div>
    <div class="friends-list">
        <div class="account-info ">
            <a href="" style="text-decoration: none;">
                <div class="mb-2" style="font-size: larger;font-weight: bolder;color: black" th:text="${user.fullName}">
                    DaVid ToNy Tèo
                </div>
                <img class="mb-2" th:src="@{__${user.profilePic}__}"
                     alt="avatar">
            </a>
        </div>
        <h4>Bạn Bè</h4>
        <th:block th:each="friend,s :${friends}">
            <a th:id="'friend-' + ${s.count}" th:data-friend-id="${friend.id}">
                <div class="friend-item">
                    <img th:src="@{__${friend.profilePic}__}"
                         th:alt="'avatar' + ${s.count}">
                    <div th:text="${friend.fullName}">John Doe</div>
                </div>
            </a>
        </th:block>
    </div>
    <div class="chat-box">
        <div class="chat-header" id="chat-header">
            <div class="friend-item" style="border-bottom: none "><img
                    src="https://haycafe.vn/wp-content/uploads/2022/02/Anh-girl-xinh-Au-My-dep-nhat.jpg" alt="Friend 2">
                <h5>John Doe</h5></div>
            <div class="d-flex">
                <i class="fas fa-phone icons" title="Voice Call" style="margin-right: 60px;"></i>
                <i class="fas fa-video icons" title="Video Call"></i>
            </div>
        </div>
        <div class="chat-messages" id="messages">
            <div class="message sent">
                <div class="message-content">Hello, how are you?</div>
            </div>
            <div class="message">
                <div class="message-content">I'm good, thank you! And you?
                    I'm good, thank you! And you?
                    I'm good, thank you! And you?I'm good, thank you! And you?I'm good, thank you! And you?
                    I'm good, thank you! And you?I'm good, thank you! And you?I'm good, thank you! And you?
                    I'm good, thank you! And you?I'm good, thank you! And you?I'm good, thank you! And you?
                    I'm good, thank you! And you?I'm good, thank you! And you?I'm good, thank you! And you?
                    I'm good, thank you! And you?I'm good, thank you! And you?I'm good, thank you! And you?
                </div>
            </div>
            <div class="message sent">
                <div class="message-content">Hello, how are you?</div>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" placeholder="Type a message..." id="message">
            <i class="fas fa-camera"></i>
            <i class="fas fa-heart"></i>
            <button id="send">Send</button>
        </div>
    </div>
</div>
<div id="user" th:attr="data-email=${user.email}, data-id=${user.id}, data-username=${user.username}"></div>
<script>
    var friendId = "";
    const userElement = document.getElementById('user');
    const email = userElement.getAttribute('data-email');
    const username = userElement.getAttribute("data-username")
    console.log(email);
    const id = userElement.getAttribute('data-id');
    $(function () {
        $('[id^="friend-"]').click(function () {
            friendId = $(this).data('friend-id');
            displayChatHeader(friendId);
            getHistory(friendId);
        });
    });

    function displayChatHeader(friendId) {
        $.ajax({
            url: "http://localhost:8080/user",
            type: "get",
            dataType: "json",
            data: {
                id: friendId
            },
            success: function (data) {
                console.log(data);
                const chatHeader = document.getElementById('chat-header');
                chatHeader.innerHTML = `
                 <div class="friend-item" style="border-bottom: none "><img
                    src="${data.profilePic}" alt="Friend 2">
                <h5>${data.fullName}</h5></div>
                <div class="d-flex">
                    <i class="fas fa-phone icons" title="Voice Call" style="margin-right: 60px;"></i>
                    <i class="fas fa-video icons" title="Video Call"></i>
                </div>`;
            }
        })
    }

    function getHistory(friendId) {
        $.ajax({
            url: "http://localhost:8080/history",
            type: "post",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify({
                sender: {
                    id: id,
                    email: email
                },
                receiver: {
                    id: friendId
                }
            }),
            success: function (data) {
                console.log("1")
                console.log(data);
                displayMessages(data);
            }
        })
    }

    function displayMessages(messages) {
        console.log("2")
        const messagesDiv = document.getElementById('messages');
        messages.forEach(message => {
            const {sender, content} = message;
            if (sender.id == id) {
                messagesDiv.innerHTML += `
                <div class="message sent">
                    <div class="message-content">${content}</div>
                </div>`;
            } else {
                messagesDiv.innerHTML += `
                <div class="message">
                    <div class="message-content">${content}</div>
                </div>`;
            }
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        console.log("3")
    }

    var stompClient = null;

    function connect() {
        var socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/messages/' + username, function (message) {
                console.log("5")
                console.log(message)
                receiveMessage(JSON.parse(message.body));
            });
        });
    }

    function sendMessage() {
        const content = document.getElementById('message').value;
        stompClient.send("/app/sendMessage", {}, JSON.stringify({
            sender: {
                id: id,
                email: email
            },
            receiver: {
                id: friendId
            },
            content: content
        }));
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += `
        <div class="message sent">
            <div class="message-content">${content}</div>
        </div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        console.log("4")
    }

    function receiveMessage(message) {
        console.log(message)
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += `
        <div class="message">
            <div class="message-content">${message.content}
            </div>
        </div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('send').onclick = function () {
        sendMessage();
    };
    connect();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
</body>
</html>